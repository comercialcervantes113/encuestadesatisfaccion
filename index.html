<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de Satisfacci√≥n - Cervantes</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS (Excel Export) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- Custom Styles for Animations & Scrollbars -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out forwards; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Custom inputs */
        input[type="radio"]:checked + div { border-color: #22d3ee; background-color: #22d3ee; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        
        .hidden-view { display: none !important; }
        
        /* Modal Blur */
        .modal-blur { backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-950 text-slate-800 min-h-screen relative overflow-x-hidden selection:bg-cyan-500/30">

    <!-- Background Layers -->
    <div class="fixed inset-0 z-0 bg-cover bg-center opacity-60" style="background-image: url('https://i.postimg.cc/6wfDzyN9/image.png')"></div>
    <div class="fixed inset-0 z-0 bg-gradient-to-br from-blue-950 via-blue-900 to-slate-900 mix-blend-multiply opacity-90"></div>
    <div class="fixed inset-0 z-0 bg-gradient-to-t from-black/80 via-blue-900/20 to-transparent"></div>
    <div class="fixed inset-0 z-0 flex items-center justify-center opacity-[0.25] pointer-events-none select-none mix-blend-overlay">
        <img src="https://i.postimg.cc/qJpzHLVp/logoic1.png" class="w-[140vw] max-w-6xl transform -rotate-12 blur-[1px]" alt="Watermark" onerror="this.style.display='none'">
    </div>

    <!-- Main Container -->
    <div class="relative z-10 container mx-auto px-4 py-8 md:py-12 flex flex-col items-center justify-center min-h-screen">

        <!-- Header -->
        <div id="app-header" class="mb-10 animate-fade-in-down flex flex-col items-center text-center">
            <img src="https://i.postimg.cc/qJpzHLVp/logoic1.png" alt="Cervantes Logo" class="h-24 md:h-32 object-contain drop-shadow-2xl mb-6 hover:scale-105 transition-transform duration-500">
            <div id="header-text">
                <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-300 via-white to-cyan-300 tracking-tight drop-shadow-lg uppercase leading-tight">
                    Calific√° a tu Asesor Comercial
                </h1>
                <div class="h-1 w-24 bg-gradient-to-r from-transparent via-cyan-500 to-transparent mt-3 mb-2 opacity-70 mx-auto"></div>
                <p class="text-blue-200 text-xs md:text-sm font-bold tracking-[0.25em] uppercase text-shadow-sm">
                    Departamento Comercial
                </p>
            </div>
        </div>

        <!-- VIEW: FORM -->
        <form id="view-form" class="w-full max-w-2xl bg-white/5 backdrop-blur-xl border border-white/10 rounded-[2rem] p-5 md:p-10 shadow-2xl animate-fade-in-up ring-1 ring-white/10 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>

            <div class="relative bg-gradient-to-r from-cyan-500/10 to-blue-600/10 -mx-5 -mt-5 md:-mx-10 md:-mt-10 p-6 md:p-8 rounded-t-[2rem] border-b border-white/10 mb-8 flex items-center gap-4">
                <div class="p-3 bg-cyan-500/20 rounded-2xl shadow-inner border border-white/10">
                    <i data-lucide="clipboard-list" class="text-cyan-300 w-7 h-7"></i>
                </div>
                <div>
                    <h3 class="text-white font-bold text-lg md:text-xl">Bienvenido a Cervantes</h3>
                    <p class="text-blue-200/70 text-xs md:text-sm">Ayudanos a mejorar</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-8 relative z-10">
                <div class="space-y-2">
                    <label class="text-blue-100 text-xs uppercase font-bold tracking-wider ml-1">Nombre Completo</label>
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-cyan-300 w-5 h-5 pointer-events-none"></i>
                        <input type="text" id="input-name" required
                            class="w-full bg-black/40 border border-white/10 rounded-xl pl-12 pr-4 py-4 text-white text-sm placeholder-white/20 focus:outline-none focus:bg-black/60 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/50 transition-all shadow-inner"
                            placeholder="Ej: Juan P√©rez">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-blue-100 text-xs uppercase font-bold tracking-wider ml-1">Carrera de Inter√©s</label>
                    <div class="relative group">
                        <i data-lucide="book-open" class="absolute left-4 top-1/2 -translate-y-1/2 text-cyan-300 w-5 h-5 pointer-events-none z-10"></i>
                        <select id="input-career" required
                            class="w-full bg-black/40 border border-white/10 text-white text-sm rounded-xl pl-12 pr-10 py-4 focus:outline-none focus:bg-black/60 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/50 transition-all cursor-pointer shadow-inner">
                            <option value="" class="text-gray-500 bg-gray-900">Selecciona la carrera...</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 pointer-events-none w-5 h-5"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-blue-100 text-xs uppercase font-bold tracking-wider ml-1">Asesor/a</label>
                    <div class="relative group">
                        <i data-lucide="briefcase" class="absolute left-4 top-1/2 -translate-y-1/2 text-cyan-300 w-5 h-5 pointer-events-none z-10"></i>
                        <select id="input-advisor" required
                            class="w-full bg-black/40 border border-white/10 text-white text-sm rounded-xl pl-12 pr-10 py-4 focus:outline-none focus:bg-black/60 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/50 transition-all cursor-pointer shadow-inner">
                            <option value="" class="text-gray-500 bg-gray-900">¬øQui√©n te atendi√≥?</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/40 pointer-events-none w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <div class="mb-8 relative z-10">
                <h3 class="text-white font-bold text-lg md:text-xl mb-6 flex items-center gap-2 border-b border-white/10 pb-3">
                    <i data-lucide="layout-dashboard" class="text-cyan-400 w-5 h-5"></i> Experiencia
                </h3>
                <div class="mb-8 text-center bg-gradient-to-b from-white/10 to-transparent p-6 rounded-2xl border border-white/10 ring-1 ring-white/10 hover:ring-cyan-500/30 transition-all group">
                    <label class="block text-white text-lg font-medium mb-1 group-hover:text-cyan-300 transition-colors">Calificaci√≥n General</label>
                    <p class="text-blue-200/60 text-xs mb-4">Toca las estrellas para calificar</p>
                    <div id="star-rating-container" class="flex justify-center space-x-2"></div>
                    <input type="hidden" id="input-rating" value="0">
                </div>
                <div id="questions-container"></div>
                <div class="space-y-2 mt-8">
                    <label class="text-blue-100 text-xs uppercase font-bold tracking-wider ml-1">Sugerencias o Comentarios</label>
                    <textarea id="input-feedback" rows="3"
                        class="w-full bg-black/40 border border-white/10 rounded-xl px-5 py-4 text-white placeholder-white/20 focus:outline-none focus:bg-black/60 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400/50 transition-all resize-none text-sm"
                        placeholder="¬øEn qu√© podemos mejorar?"></textarea>
                </div>
            </div>

            <button type="submit" id="btn-submit"
                class="relative z-10 w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-5 rounded-xl shadow-lg shadow-cyan-900/40 transform transition-all hover:-translate-y-1 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-lg tracking-wide uppercase">
                Enviar Calificaci√≥n
            </button>
        </form>

        <!-- VIEW: SUCCESS -->
        <div id="view-success" class="hidden-view w-full max-w-lg bg-white/10 backdrop-blur-xl border border-white/20 rounded-[2rem] p-10 text-center shadow-2xl animate-scale-in">
            <div class="flex justify-center mb-8">
                <div class="bg-gradient-to-tr from-green-400 to-green-600 p-5 rounded-full shadow-[0_0_30px_rgba(74,222,128,0.4)] animate-bounce">
                    <i data-lucide="check-circle" class="text-white w-16 h-16"></i>
                </div>
            </div>
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">¬°Muchas Gracias!</h2>
            <p class="text-blue-100 mb-8 leading-relaxed text-lg">Tu opini√≥n es fundamental para nosotros.</p>
            <button onclick="switchView('form')"
                class="bg-white/10 hover:bg-white/20 text-white border border-white/20 font-semibold py-4 px-10 rounded-full transition-all hover:scale-105 active:scale-95 hover:shadow-lg backdrop-blur-md">
                Volver al inicio
            </button>
        </div>

        <!-- VIEW: ADMIN DASHBOARD (NO PASSWORD) -->
        <div id="view-admin" class="hidden-view w-full max-w-7xl bg-black/80 backdrop-blur-xl border border-white/10 rounded-[2rem] overflow-hidden shadow-2xl animate-fade-in-up flex flex-col h-[90vh]">
            
            <!-- Admin Header -->
            <div class="p-6 border-b border-white/10 bg-white/5 flex flex-col xl:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="bg-cyan-500/20 p-2 rounded-xl">
                        <i data-lucide="layout-dashboard" class="text-cyan-400 w-6 h-6"></i>
                    </div>
                    <div>
                        <h2 class="text-lg md:text-xl font-bold text-white">Resultados</h2>
                        <p class="text-blue-200/50 text-xs uppercase tracking-wider">Panel de Control</p>
                    </div>
                </div>

                <div class="flex flex-wrap justify-center gap-3 w-full md:w-auto items-center">
                    
                    <!-- NEW FILTER DESIGN -->
                    <div class="relative group">
                        <div class="flex items-center gap-3 bg-white/10 px-4 py-2.5 rounded-xl border border-white/10 hover:bg-white/15 transition-all cursor-pointer">
                            <i data-lucide="filter" class="text-cyan-300 w-4 h-4"></i>
                            <select id="filter-advisor" class="bg-transparent text-white text-sm border-none focus:ring-0 cursor-pointer appearance-none pr-6 font-semibold outline-none w-full min-w-[140px]">
                                <option value="Todos" class="text-black font-bold">Todos los Asesores</option>
                                <!-- Filter options from JS -->
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 w-4 h-4 pointer-events-none"></i>
                        </div>
                    </div>

                    <!-- Share Button -->
                    <button onclick="shareSurveyLink()" class="flex items-center gap-2 px-4 py-2.5 bg-cyan-600/80 hover:bg-cyan-500 text-white rounded-xl transition text-sm font-bold shadow-lg border border-cyan-500/50">
                        <i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden md:inline">Compartir</span>
                    </button>

                    <!-- Export -->
                    <button onclick="exportToExcel()" class="flex items-center gap-2 px-4 py-2.5 bg-emerald-600/80 hover:bg-emerald-500 text-white rounded-xl transition text-sm font-bold shadow-lg border border-emerald-500/50">
                        <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden md:inline">Excel</span>
                    </button>
                    
                    <!-- Logout -->
                    <button onclick="switchView('form')" class="flex items-center gap-2 px-4 py-2.5 bg-red-500/20 hover:bg-red-500/40 text-red-200 rounded-xl transition text-sm border border-red-500/20">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                
                <!-- KPIS -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl">
                        <div class="text-blue-200 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">Total</div>
                        <div id="stat-total" class="text-2xl md:text-4xl font-bold text-white">0</div>
                    </div>
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl">
                        <div class="text-blue-200 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">Promedio</div>
                        <div id="stat-avg" class="text-2xl md:text-4xl font-bold text-yellow-400">0.0</div>
                    </div>
                    <div class="col-span-2 bg-white/5 border border-white/10 p-5 rounded-2xl flex flex-col justify-center">
                        <div class="text-blue-200 text-[10px] md:text-xs font-bold uppercase tracking-wider mb-1">√öltimo Feedback</div>
                        <div id="stat-last-feedback" class="text-white text-xs md:text-sm italic truncate opacity-70">-</div>
                    </div>
                </div>

                <!-- Charts Area (Grid 2x2 now) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl backdrop-blur-md">
                        <h4 class="text-white font-semibold mb-4 text-xs md:text-sm uppercase tracking-wider flex items-center gap-2"><i data-lucide="info" class="text-cyan-400 w-4 h-4"></i> Claridad</h4><div id="chart-clarity" class="space-y-3"></div>
                    </div>
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl backdrop-blur-md">
                        <h4 class="text-white font-semibold mb-4 text-xs md:text-sm uppercase tracking-wider flex items-center gap-2"><i data-lucide="check-circle-2" class="text-green-400 w-4 h-4"></i> Decisi√≥n</h4><div id="chart-decision" class="space-y-3"></div>
                    </div>
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl backdrop-blur-md">
                        <h4 class="text-white font-semibold mb-4 text-xs md:text-sm uppercase tracking-wider flex items-center gap-2"><i data-lucide="credit-card" class="text-purple-400 w-4 h-4"></i> Pagos</h4><div id="chart-payment" class="space-y-3"></div>
                    </div>
                    <div class="bg-white/5 border border-white/10 p-5 rounded-2xl backdrop-blur-md">
                        <h4 class="text-white font-semibold mb-4 text-xs md:text-sm uppercase tracking-wider flex items-center gap-2"><i data-lucide="timer" class="text-orange-400 w-4 h-4"></i> Velocidad</h4><div id="chart-speed" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden backdrop-blur-md">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-black/40 text-blue-200 text-xs uppercase tracking-wider sticky top-0">
                                <tr>
                                    <th class="p-4 font-semibold">Fecha</th>
                                    <th class="p-4 font-semibold">Inscripto</th>
                                    <th class="p-4 font-semibold">Carrera</th>
                                    <th class="p-4 font-semibold">Asesor</th>
                                    <th class="p-4 font-semibold text-center">‚òÖ</th>
                                    <th class="p-4 font-semibold">Estado</th>
                                    <th class="p-4 font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-white/5 text-white text-xs md:text-sm">
                                <!-- Rows filled by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- MODAL EDITAR -->
    <div id="modal-edit" class="hidden-view fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 modal-blur" onclick="closeEditModal()"></div>
        <div class="relative bg-slate-900 border border-white/20 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-scale-in">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="text-white font-bold text-lg flex items-center gap-2"><i data-lucide="edit-3" class="text-cyan-400 w-5 h-5"></i> Editar Respuesta</h3>
                <button onclick="closeEditModal()" class="text-white/50 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-edit" class="p-6 space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label class="text-xs text-blue-200 uppercase font-bold tracking-wider">Nombre</label>
                    <input type="text" id="edit-name" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-cyan-400 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-blue-200 uppercase font-bold tracking-wider">Carrera</label>
                        <select id="edit-career" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-cyan-400 outline-none"></select>
                    </div>
                    <div>
                        <label class="text-xs text-blue-200 uppercase font-bold tracking-wider">Asesor</label>
                        <select id="edit-advisor" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-cyan-400 outline-none"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-blue-200 uppercase font-bold tracking-wider">Calificaci√≥n</label>
                        <select id="edit-rating" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-cyan-400 outline-none">
                            <option value="1">1 Estrella</option>
                            <option value="2">2 Estrellas</option>
                            <option value="3">3 Estrellas</option>
                            <option value="4">4 Estrellas</option>
                            <option value="5">5 Estrellas</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs text-blue-200 uppercase font-bold tracking-wider">Feedback</label>
                    <textarea id="edit-feedback" rows="3" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-cyan-400 outline-none resize-none"></textarea>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2.5 rounded-xl border border-white/10 text-white/70 hover:bg-white/5 font-semibold">Cancelar</button>
                    <button type="submit" class="flex-1 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white font-bold shadow-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

        // --- Configuraci√≥n ---
        const firebaseConfig = {
            apiKey: "AIzaSyBEQEvQl1koLdxXIHqDxtN6rL10_o9eOgY",
            authDomain: "encuestadesatisfaccion-b8987.firebaseapp.com",
            projectId: "encuestadesatisfaccion-b8987",
            storageBucket: "encuestadesatisfaccion-b8987.firebasestorage.app",
            messagingSenderId: "1053389851284",
            appId: "1:1053389851284:web:23faa57734226919c78281",
            measurementId: "G-NGKBBFB24C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        try { const analytics = getAnalytics(app); } catch (e) {}

        const CAREERS = [
            'Higiene y Seguridad', 'Gesti√≥n Inmobiliaria', 'Administraci√≥n de Empresas',
            'Ciencia de Datos e Inteligencia Artificial', 'Analista de Sistemas',
            'Recursos Humanos', 'Marketing', 'Desarrollo Web y Aplicaciones Digitales'
        ];
        const ADVISORS = ['Belen', 'Kiara', 'Jeremias', 'Laura', 'No recuerdo'];
        
        const getIconForAnswer = (text) => {
            if (!text) return "";
            if (text.includes("S√≠") || text.includes("Adecuado") || text.includes("Muy decidido")) return "‚úÖ " + text;
            if (text.includes("No") || text.includes("Lento") || text.includes("No estoy")) return "‚ùå " + text;
            if (text.includes("Parcialmente") || text.includes("dudas") || text.includes("Bastante")) return "‚ö†Ô∏è " + text;
            if (text.includes("Muy r√°pido")) return "üöÄ " + text;
            return text;
        };

        let surveysData = [];
        let currentFilter = "Todos";

        const views = {
            form: document.getElementById('view-form'),
            success: document.getElementById('view-success'),
            admin: document.getElementById('view-admin')
        };
        const headerText = document.getElementById('header-text');

        window.switchView = (viewName) => {
            Object.values(views).forEach(el => { if(el) el.classList.add('hidden-view'); });
            if (views[viewName]) views[viewName].classList.remove('hidden-view');
            if (viewName === 'form' || viewName === 'success') headerText.style.display = 'block';
            else headerText.style.display = 'none';
            if (viewName === 'admin') loadAdminData();
            window.scrollTo(0, 0);
        };

        function initForm() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'admin') switchView('admin');

            const populate = (id, opts, isEdit) => {
                const sel = document.getElementById(id);
                sel.innerHTML = isEdit ? '' : `<option value="" class="text-gray-500 bg-gray-900">${isEdit ? '' : 'Selecciona...'}</option>`;
                opts.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o; opt.textContent = o; 
                    opt.className = isEdit ? "text-white bg-slate-900" : "text-white bg-gray-900 py-2";
                    sel.appendChild(opt);
                });
            };

            populate('input-career', CAREERS);
            populate('input-advisor', ADVISORS);
            
            // Populate Modal Selects
            populate('edit-career', CAREERS, true);
            populate('edit-advisor', ADVISORS, true);

            const filterSelect = document.getElementById('filter-advisor');
            ADVISORS.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a; opt.textContent = a; opt.className = "text-black";
                filterSelect.appendChild(opt);
            });
            filterSelect.addEventListener('change', (e) => {
                currentFilter = e.target.value;
                renderAdminDashboard();
            });

            const starContainer = document.getElementById('star-rating-container');
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = "transition-all duration-300 hover:scale-125 focus:outline-none text-blue-200/20";
                btn.innerHTML = `<i data-lucide="star" class="w-10 h-10 star-icon" stroke-width="1.5"></i>`;
                btn.onclick = () => setRating(i);
                starContainer.appendChild(btn);
            }

            const qContainer = document.getElementById('questions-container');
            const questions = [
                { id: 'clarity', label: '¬øLa informaci√≥n sobre la carrera y modalidades fue clara?', opts: ['S√≠', 'Parcialmente', 'No'] },
                { id: 'paymentInfo', label: '¬øTe explicaron bien los descuentos y formas de pago?', opts: ['S√≠', 'No', 'Me quedaron dudas'] },
                { id: 'responseSpeed', label: 'Velocidad de respuesta', opts: ['Muy r√°pido', 'Adecuado', 'Lento'] },
                { id: 'decision', label: '¬øC√≥mo te sientes respecto a inscribirte?', opts: ['Muy decidido/a', 'Bastante decidido/a', 'Con dudas', 'No estoy interesado/a'] }
            ];

            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = "mb-6 bg-white/5 p-4 md:p-5 rounded-2xl border border-white/10 backdrop-blur-sm hover:bg-white/10 transition-colors";
                div.innerHTML = `<label class="block text-white font-medium mb-3 text-sm md:text-base">${q.label}</label>`;
                const optsDiv = document.createElement('div');
                optsDiv.className = "flex flex-col gap-2.5";
                q.opts.forEach(opt => {
                    const label = document.createElement('label');
                    label.className = "flex items-center space-x-3 cursor-pointer group hover:bg-white/5 p-2 rounded-xl transition-all";
                    label.innerHTML = `<div class="w-5 h-5 rounded-full border-2 border-white/30 flex items-center justify-center transition-all radio-indicator"></div><input type="radio" name="${q.id}" value="${opt}" class="hidden" onchange="updateRadios('${q.id}', this)"><span class="text-sm md:text-base text-blue-100/70 group-hover:text-blue-100 transition-colors">${opt}</span>`;
                    optsDiv.appendChild(label);
                });
                div.appendChild(optsDiv);
                qContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        window.setRating = (rating) => {
            document.getElementById('input-rating').value = rating;
            const stars = document.querySelectorAll('#star-rating-container button');
            stars.forEach((btn, idx) => {
                const icon = btn.querySelector('.star-icon');
                if (idx < rating) {
                    btn.classList.remove('text-blue-200/20');
                    btn.classList.add('text-yellow-400', 'drop-shadow-[0_0_8px_rgba(250,204,21,0.5)]');
                    icon.setAttribute('fill', 'currentColor');
                } else {
                    btn.classList.add('text-blue-200/20');
                    btn.classList.remove('text-yellow-400', 'drop-shadow-[0_0_8px_rgba(250,204,21,0.5)]');
                    icon.setAttribute('fill', 'none');
                }
            });
            lucide.createIcons();
        };

        window.updateRadios = (groupName, input) => {
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(radio => {
                const container = radio.parentElement;
                const indicator = container.querySelector('.radio-indicator');
                const text = container.querySelector('span');
                if (radio.checked) {
                    indicator.classList.remove('border-white/30');
                    indicator.classList.add('border-cyan-400', 'bg-cyan-400', 'scale-110', 'shadow-[0_0_10px_rgba(34,211,238,0.4)]');
                    indicator.innerHTML = '<div class="w-2 h-2 rounded-full bg-white"></div>';
                    text.classList.add('text-white', 'font-semibold');
                    text.classList.remove('text-blue-100/70');
                } else {
                    indicator.classList.add('border-white/30');
                    indicator.classList.remove('border-cyan-400', 'bg-cyan-400', 'scale-110', 'shadow-[0_0_10px_rgba(34,211,238,0.4)]');
                    indicator.innerHTML = '';
                    text.classList.remove('text-white', 'font-semibold');
                    text.classList.add('text-blue-100/70');
                }
            });
        };

        document.getElementById('view-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const getVal = (id) => document.getElementById(id).value;
            const getRadio = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value;
            const data = {
                name: getVal('input-name'),
                career: getVal('input-career'),
                advisor: getVal('input-advisor'),
                rating: parseInt(getVal('input-rating')),
                feedback: getVal('input-feedback'),
                clarity: getRadio('clarity'),
                paymentInfo: getRadio('paymentInfo'),
                responseSpeed: getRadio('responseSpeed'),
                decision: getRadio('decision'),
                timestamp: serverTimestamp()
            };
            if (!data.rating || !data.career || !data.advisor || !data.clarity) {
                alert("Por favor completa los campos y selecciona una calificaci√≥n.");
                return;
            }
            const btn = document.getElementById('btn-submit');
            btn.textContent = "ENVIANDO..."; btn.disabled = true;
            try {
                await addDoc(collection(db, 'cervantes_surveys'), data);
                document.getElementById('view-form').reset();
                setRating(0);
                document.querySelectorAll('input[type="radio"]').forEach(r => { r.checked = false; updateRadios(r.name, r); });
                switchView('success');
            } catch (err) { alert("Error al enviar."); }
            btn.textContent = "ENVIAR CALIFICACI√ìN"; btn.disabled = false;
        });

        // --- Admin Functions ---
        let unsubscribe = null;
        function loadAdminData() {
            if (unsubscribe) return;
            unsubscribe = onSnapshot(collection(db, 'cervantes_surveys'), (snapshot) => {
                surveysData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                surveysData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderAdminDashboard();
            });
        }

        function renderAdminDashboard() {
            const filtered = currentFilter === "Todos" ? surveysData : surveysData.filter(s => s.advisor === currentFilter);
            const total = filtered.length;
            const avg = total > 0 ? (filtered.reduce((a, b) => a + (b.rating || 0), 0) / total).toFixed(1) : "0.0";
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-avg').textContent = avg;
            document.getElementById('stat-last-feedback').textContent = filtered.length > 0 ? `"${filtered[0].feedback || '...'}"` : "-";

            const renderChart = (id, field, opts, color) => {
                const con = document.getElementById(id); con.innerHTML = "";
                const max = Math.max(...opts.map(o => filtered.filter(f => f[field] === o).length), 1);
                opts.forEach(o => {
                    const c = filtered.filter(f => f[field] === o).length;
                    const p = (c / max) * 100;
                    con.innerHTML += `<div class="relative"><div class="flex justify-between text-[10px] md:text-xs text-blue-100 mb-1"><span class="truncate pr-2">${getIconForAnswer(o)}</span><span class="font-mono">${c}</span></div><div class="w-full bg-white/5 rounded-full h-2 overflow-hidden"><div class="h-full rounded-full transition-all duration-1000 ${color}" style="width: ${p}%"></div></div></div>`;
                });
            };
            renderChart('chart-clarity', 'clarity', ['S√≠', 'Parcialmente', 'No'], 'bg-cyan-500');
            renderChart('chart-decision', 'decision', ['Muy decidido/a', 'Bastante decidido/a', 'Con dudas', 'No estoy interesado/a'], 'bg-green-500');
            renderChart('chart-payment', 'paymentInfo', ['S√≠', 'No', 'Me quedaron dudas'], 'bg-purple-500');
            renderChart('chart-speed', 'responseSpeed', ['Muy r√°pido', 'Adecuado', 'Lento'], 'bg-orange-500');

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = "";
            if (filtered.length === 0) tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-white/30">No hay datos.</td></tr>`;
            else {
                filtered.forEach(s => {
                    const date = s.timestamp ? new Date(s.timestamp.seconds * 1000).toLocaleDateString() : '-';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors group";
                    tr.innerHTML = `
                        <td class="p-4 whitespace-nowrap opacity-60">${date}</td>
                        <td class="p-4 font-medium">${s.name}</td>
                        <td class="p-4"><span class="px-2 py-1 bg-white/5 rounded text-[10px] border border-white/5">${s.career}</span></td>
                        <td class="p-4 text-cyan-200">${s.advisor}</td>
                        <td class="p-4 text-center font-bold text-yellow-400">${s.rating}</td>
                        <td class="p-4 opacity-70 text-xs">${getIconForAnswer(s.decision)}</td>
                        <td class="p-4 flex gap-2 justify-end opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.openEdit('${s.id}')" class="p-2 bg-blue-500/20 hover:bg-blue-500 text-blue-200 hover:text-white rounded-lg transition"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteSurvey('${s.id}')" class="p-2 bg-red-500/20 hover:bg-red-500 text-red-200 hover:text-white rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }
        }

        // --- Edit / Delete Logic ---
        window.openEdit = (id) => {
            const s = surveysData.find(x => x.id === id);
            if(!s) return;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = s.name;
            document.getElementById('edit-career').value = s.career;
            document.getElementById('edit-advisor').value = s.advisor;
            document.getElementById('edit-rating').value = s.rating;
            document.getElementById('edit-feedback').value = s.feedback || '';
            document.getElementById('modal-edit').classList.remove('hidden-view');
        };

        window.closeEditModal = () => document.getElementById('modal-edit').classList.add('hidden-view');

        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const updateData = {
                name: document.getElementById('edit-name').value,
                career: document.getElementById('edit-career').value,
                advisor: document.getElementById('edit-advisor').value,
                rating: parseInt(document.getElementById('edit-rating').value),
                feedback: document.getElementById('edit-feedback').value
            };
            try {
                await updateDoc(doc(db, "cervantes_surveys", id), updateData);
                closeEditModal();
            } catch(err) { alert("Error al actualizar"); }
        });

        window.deleteSurvey = async (id) => {
            if(confirm("¬øEst√°s seguro de eliminar esta encuesta? No se puede deshacer.")) {
                try {
                    await deleteDoc(doc(db, "cervantes_surveys", id));
                } catch(err) { alert("Error al eliminar"); }
            }
        };

        window.exportToExcel = () => {
            const data = currentFilter === "Todos" ? surveysData : surveysData.filter(s => s.advisor === currentFilter);
            const ws = XLSX.utils.json_to_sheet(data.map(i => ({
                Fecha: i.timestamp ? new Date(i.timestamp.seconds*1000).toLocaleDateString() : 'N/A',
                Nombre: i.name, Carrera: i.career, Asesor: i.advisor, Calificaci√≥n: i.rating,
                Claridad: i.clarity, Pagos: i.paymentInfo, Velocidad: i.responseSpeed, Decisi√≥n: i.decision, Feedback: i.feedback
            })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Encuestas");
            XLSX.writeFile(wb, "Reporte_Cervantes.xlsx");
        };

        window.shareSurveyLink = async () => {
            const url = window.location.href.split('?')[0];
            if (navigator.share) await navigator.share({ title: 'Encuesta', text: 'Ay√∫danos a mejorar', url });
            else { await navigator.clipboard.writeText(url); alert("Link copiado!"); }
        };

        onAuthStateChanged(auth, (user) => { if (!user) signInAnonymously(auth); });
        initForm();
    </script>
</body>
</html>
